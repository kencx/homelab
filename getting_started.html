<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Getting Started - Homelab Documentation</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="index.html">Home</a></li><li class="chapter-item expanded affix "><a href="prerequisites.html">Prerequisites</a></li><li class="chapter-item expanded affix "><a href="getting_started.html" class="active">Getting Started</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">Infrastructure</li><li class="chapter-item expanded "><a href="provisioning.html">Provisioning</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="images/index.html">Images</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="images/cloud_image.html">Cloud Images</a></li><li class="chapter-item "><a href="images/packer.html">Packer</a></li></ol></li><li class="chapter-item "><a href="terraform/index.html">Terraform</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="terraform/postgres.html">Postgres</a></li><li class="chapter-item "><a href="terraform/proxmox.html">Proxmox</a></li><li class="chapter-item "><a href="terraform/vault.html">Vault</a></li></ol></li><li class="chapter-item "><a href="ansible/index.html">Ansible</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="ansible/roles/index.html">Roles</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="ansible/roles/common.html">Common</a></li><li class="chapter-item "><a href="ansible/roles/consul.html">Consul</a></li><li class="chapter-item "><a href="ansible/roles/consul-template.html">Consul Template</a></li><li class="chapter-item "><a href="ansible/roles/issue_cert.html">Issue Cert</a></li><li class="chapter-item "><a href="ansible/roles/nomad.html">Nomad</a></li><li class="chapter-item "><a href="ansible/roles/unseal_vault.html">Unseal Vault</a></li><li class="chapter-item "><a href="ansible/roles/vault.html">Vault</a></li></ol></li></ol></li></ol></li><li class="chapter-item expanded "><li class="part-title">Applications</li><li class="chapter-item expanded "><a href="apps/index.html">Applications</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="apps/add_new.html">Adding New Application</a></li><li class="chapter-item "><a href="apps/diun.html">Diun</a></li><li class="chapter-item "><a href="apps/registry.html">Registry</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">References</li><li class="chapter-item expanded "><a href="references/issues.html">Known Issues</a></li><li class="chapter-item expanded "><a href="references/TODO.html">Roadmap</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Homelab Documentation</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/kencx/homelab" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="getting-started"><a class="header" href="#getting-started">Getting Started</a></h1>
<p>Our goal is to provision a Nomad, Consul and Vault cluster with one server node
and one client node. The basic provisioning flow is as follows:</p>
<ol>
<li>Packer creates base Proxmox VM templates from cloud images and ISOs</li>
<li>Terraform provisions cluster nodes by cloning existing VM templates</li>
<li>Ansible installs and configures Vault, Consul, Nomad on cluster nodes</li>
</ol>
<h3 id="assumptions"><a class="header" href="#assumptions">Assumptions</a></h3>
<p>The following assumptions are made in this guide:</p>
<ul>
<li>All <a href="./prerequisites.html">prerequisites</a> are fulfilled</li>
<li>The cluster is provisioned on a Proxmox server</li>
<li>All nodes are running Debian 11 virtual machines (not LXCs)</li>
</ul>
<p>Please make the necessary changes if there are any deviations from the above.</p>
<h2 id="creating-a-vm-template"><a class="header" href="#creating-a-vm-template">Creating a VM template</a></h2>
<p>The Proxmox builder plugin is used to create a new VM template. It supports two
different builders:</p>
<ul>
<li><code>proxmox-clone</code> - From an <a href="./images/packer.html#proxmox-clone">existing VM template</a> (recommended)</li>
<li><code>proxmox-iso</code> - From an <a href="./images/packer.html#proxmox-iso">ISO file</a> (incomplete)</li>
</ul>
<p>We will be using the first builder. If you have an existing template to
provision, you may <a href="#provisioning-with-terraform">skip to the next section</a>.
Otherwise, assuming that we are lacking an existing, clean VM template, we will
import a cloud image and turn it into a new template.</p>
<blockquote>
<p><strong>Note</strong>: It is important that the existing template <a href="https://pve.proxmox.com/wiki/Cloud-Init_Support#_preparing_cloud_init_templates">must
have</a>:</p>
<ul>
<li>An attached cloud-init drive for the builder to add the SSH communicator
configuration</li>
<li>cloud-init installed</li>
<li>qemu-guest-agent installed</li>
</ul>
</blockquote>
<ol>
<li>(Optional) Run the <code>bin/import-cloud-image</code> <a href="./images/cloud_image.html#script">script</a> to import a new cloud image:</li>
</ol>
<pre><code class="language-bash">$ import-cloud-image [URL]
</code></pre>
<ol start="2">
<li>Navigate to <code>packer/base-clone</code></li>
</ol>
<blockquote>
<p><strong>Tip</strong>: Use the <code>bin/generate-vars</code> script to quickly generate variable files
in <code>packer</code> and <code>terraform</code> subdirectories.</p>
</blockquote>
<ol start="3">
<li>Populate the necessary variables in <code>auto.pkrvars.hcl</code>:</li>
</ol>
<pre><code class="language-hcl">proxmox_url      = "https://&lt;PVE_IP&gt;:8006/api2/json"
proxmox_username = "&lt;user&gt;@pam"
proxmox_password = "&lt;password&gt;"

clone_vm = "&lt;cloud-image-name&gt;"
vm_name  = "&lt;new-template-name&gt;"
vm_id    = 5000

ssh_username = "debian"
ssh_public_key_path = "/path/to/public/key"
ssh_private_key_path = "/path/to/private/key"
</code></pre>
<ol start="4">
<li>Build the image:</li>
</ol>
<pre><code class="language-bash">$ packer validate -var-file="auto.pkrvars.hcl" .
$ packer build -var-file="auto.pkrvars.hcl" .
</code></pre>
<p>Packer will create a new base image and use the Ansible post-provisioner to
install and configure software (eg. Docker, Nomad, Consul and Vault). For more
details, see <a href="./images/packer.html#proxmox-clone">Packer</a>.</p>
<h2 id="provisioning-with-terraform"><a class="header" href="#provisioning-with-terraform">Provisioning with Terraform</a></h2>
<p>We are using the
<a href="https://registry.terraform.io/providers/bpg/proxmox/latest/docs">bpg/proxmox</a>
provider to provision virtual machines from our Packer templates.</p>
<ol>
<li>Navigate to <code>terraform/cluster</code></li>
<li>Populate the necessary variables in <code>terraform.tfvars</code>:</li>
</ol>
<pre><code class="language-hcl">proxmox_ip        = "https://&lt;PVE_IP&gt;:8006/api2/json"
proxmox_api_token = "&lt;API_TOKEN&gt;"

template_id = 5000
ip_gateway  = "10.10.10.1"

servers = [
  {
    name       = "server"
    id         = 110
    cores      = 2
    sockets    = 2
    memory     = 4096
    disk_size  = 10
    ip_address = "10.10.10.110/24"
  }
]

clients = [
  {
    name       = "client"
    id         = 111
    cores      = 2
    sockets    = 2
    memory     = 10240
    disk_size  = 15
    ip_address = "10.10.10.111/24"
  }
]

ssh_user             = "debian"
ssh_private_key_file = "/path/to/ssh/private/key"
ssh_public_key_file  = "/path/to/ssh/public/key"
</code></pre>
<!-- >**Note**: To create a Proxmox API token, see [Access -->
<!-- >Management](./terraform/proxmox.md#access-management). -->
<ol start="3">
<li>Provision the cluster:</li>
</ol>
<pre><code class="language-bash">$ terraform init
$ terraform plan
$ terraform apply
</code></pre>
<p>The above configuration will provision two VM nodes in Proxmox:</p>
<pre><code>Server node: VMID 110 at 10.10.10.110
Client node: VMID 111 at 10.10.10.111
</code></pre>
<p>An Ansible inventory file <code>tf_ansible_inventory</code> should be generated in the same
directory with the given VM IPs in the <code>server</code> and <code>client</code> groups.</p>
<p>For more details, refer to the <a href="terraform/proxmox.html">Terraform configuration for
Proxmox</a>.</p>
<h2 id="configuration-with-ansible"><a class="header" href="#configuration-with-ansible">Configuration with Ansible</a></h2>
<p>At this stage, there should be one server node and one client node running on
Proxmox that is reachable by SSH. These nodes should have Nomad, Consul and
Vault installed. We will proceed to use Ansible (and Terraform) to configure
Vault, Consul and Nomad (in that order) into a working cluster.</p>
<ol>
<li>Navigate to <code>ansible</code></li>
<li>Ensure that the Terraform-generated Ansible inventory file is being read:</li>
</ol>
<pre><code class="language-bash">$ ansible-inventory --graph
</code></pre>
<ol start="3">
<li>Populate and check the <code>group_vars</code> files in
<code>inventory/group_vars/{prod,server,client}.yml</code></li>
</ol>
<pre><code class="language-bash">$ ansible-inventory --graph --vars
</code></pre>
<blockquote>
<p><strong>Note</strong>: The <code>nfs_share_mounts</code> variable in <code>inventory/group_vars/client.yml</code>
should be modified or removed if not required</p>
</blockquote>
<ol start="4">
<li>Run the playbook:</li>
</ol>
<pre><code class="language-bash">$ ansible-playbook main.yml
</code></pre>
<p>The playbook will perform the following:</p>
<ol>
<li>Create a root and intermediate CA for Vault</li>
<li>Configure Vault to use new CA</li>
<li>Initialize Vault roles, authentication and PKI with Terraform with
<a href="./terraform/vault.html">configuration</a> in <code>terraform/vault</code></li>
<li>Configure Vault-agent and consul-template in server node</li>
<li>Configure Consul and Nomad in server node. These roles depend on Vault being
successfully configured and started as they require Vault to generate a
gossip key and TLS certificates</li>
<li>Repeat 4-5 for client node</li>
</ol>
<h3 id="note-on-data-loss"><a class="header" href="#note-on-data-loss">Note on Data Loss</a></h3>
<p>When re-running the playbook on the same server, Vault will not be
re-initialized. However, if the playbook is run on a separate server (eg. for
testing on a dev cluster), the Vault role will permanently delete any
existing state in the <code>terraform/vault</code> subdirectory if a different
<code>vault_terraform_workspace</code> is not provided. This WILL result in permanent data
loss and care should be taken when running the role (and playbook) on multiple
clusters or servers.</p>
<h2 id="post-setup"><a class="header" href="#post-setup">Post Setup</a></h2>
<h3 id="smoke-tests"><a class="header" href="#smoke-tests">Smoke Tests</a></h3>
<p>Smoke tests are performed with <a href="https://github.com/goss-org/goss">goss</a> as part
of the <code>main.yml</code> playbook to ensure all required software are installed and
running.</p>
<blockquote>
<p><strong>Note</strong>: The included goss files are static with hardcoded information. As
such, they will fail if some of the Ansible default variables are changed (eg.
username, NFS mountpoints). See
<a href="./references/issues.html#static-goss-files">issues</a> for details on a workaround.</p>
</blockquote>
<h3 id="running-applications"><a class="header" href="#running-applications">Running Applications</a></h3>
<p>After verifying that the cluster is up and running, we can begin to run
applications on it with Nomad jobs. This project provides a number of Nomad
jobspec files in <code>terraform/nomad/apps</code> to be run with Terraform with the
following features:</p>
<ul>
<li>With Vault integration configured, Nomad supports the fetching of application
secrets with Vault</li>
<li>Traefik as a reverse proxy</li>
<li>(Optional) Postgres as a database (with Vault-managed DB credentials)</li>
</ul>
<p>See <a href="./apps/add_new.html">Adding a New Application</a> for details on onboarding a
new application to Nomad.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="prerequisites.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="provisioning.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="prerequisites.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="provisioning.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
